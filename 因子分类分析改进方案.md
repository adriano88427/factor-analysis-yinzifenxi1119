# 因子分类分析改进方案

## 任务概述
根据用户要求，对因子分析报告进行改进，将因子分为正向因子和负向因子两类，并分别进行详细分析。

## 现状分析
从当前报告 `因子分析详情_精简版_20251120_220936.txt` 可知：

### 现有因子分类
**正向因子** (IC均值 > 0):
1. 前10日最大涨幅 - IC均值: 0.124, 排名第1
2. 信号当日收盘涨跌幅 - IC均值: 0.088, 排名第2  
3. 次日开盘后总体下跌幅度 - IC均值: 0.029, 排名第3

**负向因子** (IC均值 < 0):
1. 信号后一日开盘涨跌幅 - IC均值: -0.024, 排名第1
2. 当日回调 - IC均值: -0.018, 排名第2
3. 日最大跌幅百分比 - IC均值: -0.007, 排名第3
4. 信号发出时上市天数 - IC均值: -0.004, 排名第4

## 改进方案

### 1. 报告结构改进
```
新的因子分析报告结构:
├── 1. 因子分类概览
│   ├── 正向因子概览
│   └── 负向因子概览
├── 2. 正向因子详细分析
│   ├── 2.1 正向因子排行榜
│   ├── 2.2 正向因子综合评估
│   ├── 2.3 各正向因子详细分析
│   └── 2.4 正向因子使用建议
├── 3. 负向因子详细分析  
│   ├── 3.1 负向因子排行榜
│   ├── 3.2 负向因子综合评估
│   ├── 3.3 各负向因子详细分析
│   └── 3.4 负向因子使用建议
└── 4. 因子组合配置建议
```

### 2. 代码修改详细方案

#### 2.1 添加因子分类函数
```python
def classify_factors_by_ic(df_analysis):
    """
    根据IC均值对因子进行分类
    
    Args:
        df_analysis: 因子分析DataFrame
        
    Returns:
        tuple: (正向因子DataFrame, 负向因子DataFrame)
    """
    # 排序因子，IC均值从高到低
    df_sorted = df_analysis.sort_values('IC均值', ascending=False).reset_index(drop=True)
    
    # 分离正向因子和负向因子
    positive_factors = df_sorted[df_sorted['IC均值'] > 0].copy()
    negative_factors = df_sorted[df_sorted['IC均值'] < 0].copy()
    
    # 重新编号
    positive_factors.reset_index(drop=True, inplace=True)
    negative_factors.reset_index(drop=True, inplace=True)
    
    return positive_factors, negative_factors
```

#### 2.2 修改报告生成函数
```python
def generate_classified_factor_report(df_analysis, save_path, analysis_params):
    """
    生成按分类的因子分析报告
    
    Args:
        df_analysis: 因子分析DataFrame
        save_path: 保存路径
        analysis_params: 分析参数
    """
    
    # 分类因子
    positive_factors, negative_factors = classify_factors_by_ic(df_analysis)
    
    # 生成报告内容
    report_lines = []
    
    # 1. 因子分类概览
    report_lines.extend(generate_factor_classification_overview(positive_factors, negative_factors))
    
    # 2. 正向因子详细分析
    report_lines.extend(generate_positive_factors_analysis(positive_factors, analysis_params))
    
    # 3. 负向因子详细分析
    report_lines.extend(generate_negative_factors_analysis(negative_factors, analysis_params))
    
    # 4. 因子组合配置建议
    report_lines.extend(generate_factor_combination_suggestions(positive_factors, negative_factors))
    
    # 保存报告
    with open(save_path, 'w', encoding='utf-8') as f:
        f.write('\n'.join(report_lines))
```

#### 2.3 正向因子分析函数
```python
def generate_positive_factors_analysis(positive_factors, analysis_params):
    """
    生成正向因子详细分析
    
    Args:
        positive_factors: 正向因子DataFrame
        analysis_params: 分析参数
        
    Returns:
        list: 报告行列表
    """
    report_lines = []
    
    # 标题
    report_lines.append("2. 正向因子详细分析")
    report_lines.append("=" * 60)
    report_lines.append("")
    
    # 2.1 正向因子排行榜
    report_lines.append("2.1 正向因子排行榜")
    report_lines.append("-" * 40)
    report_lines.append("")
    report_lines.append(f"【共 {len(positive_factors)} 个正向因子】")
    report_lines.append("")
    
    # 表格头
    report_lines.append(f"{'排名':<4} {'因子名称':<25} {'得分':<8} {'评级':<8} {'IC均值':<10} {'IR值':<10}")
    report_lines.append("-" * 80)
    
    for i, row in positive_factors.iterrows():
        rank = i + 1
        factor_name = row['因子名称']
        score = f"{row['综合得分']:.1f}"
        rating = row['评级']
        ic_mean = f"{row['IC均值']:.3f}"
        ir_value = f"{row['IR值']:.3f}"
        
        report_lines.append(f"{rank:<4} {factor_name:<25} {score:<8} {rating:<8} {ic_mean:<10} {ir_value:<10}")
    
    report_lines.append("")
    if len(positive_factors) > 0:
        best_positive = positive_factors.iloc[0]
        report_lines.append(f"最佳正向因子: {best_positive['因子名称']} (排名第1)")
    report_lines.append("")
    
    # 2.2 正向因子综合评估
    report_lines.append("2.2 正向因子综合评估")
    report_lines.append("-" * 40)
    report_lines.append("")
    
    if len(positive_factors) > 0:
        # 统计信息
        total_count = len(positive_factors)
        avg_ic = positive_factors['IC均值'].mean()
        avg_ir = positive_factors['IR值'].mean()
        top_ic = positive_factors['IC均值'].max()
        top_ir = positive_factors['IR值'].max()
        
        # 评级分布
        rating_dist = positive_factors['评级'].value_counts()
        
        report_lines.append(f"正向因子总数: {total_count}个")
        report_lines.append(f"平均IC均值: {avg_ic:.3f}")
        report_lines.append(f"平均IR值: {avg_ir:.3f}")
        report_lines.append(f"最高IC均值: {top_ic:.3f}")
        report_lines.append(f"最高IR值: {top_ir:.3f}")
        report_lines.append("")
        report_lines.append("评级分布:")
        for rating, count in rating_dist.items():
            report_lines.append(f"  {rating}级: {count}个")
        report_lines.append("")
    
    # 2.3 各正向因子详细分析
    report_lines.append("2.3 各正向因子详细分析")
    report_lines.append("-" * 40)
    report_lines.append("")
    
    for i, row in positive_factors.iterrows():
        report_lines.extend(generate_positive_factor_detail_analysis(row, i + 1))
    
    # 2.4 正向因子使用建议
    report_lines.append("2.4 正向因子使用建议")
    report_lines.append("-" * 40)
    report_lines.append("")
    report_lines.extend(generate_positive_factors_usage_suggestions(positive_factors))
    
    return report_lines

def generate_positive_factor_detail_analysis(row, rank):
    """
    生成单个正向因子的详细分析
    """
    report_lines = []
    
    report_lines.append(f"【{row['评级']}】{row['因子名称']}")
    report_lines.append("-" * 50)
    report_lines.append(f"综合得分: {row['综合得分']:.1f}/10")
    report_lines.append(f"风险等级: {get_risk_level(row['综合得分'])}")
    report_lines.append("")
    
    report_lines.append("核心指标:")
    report_lines.append(f"• IC均值: {row['IC均值']:.3f}")
    report_lines.append(f"• IR值: {row['IR值']:.3f}")
    report_lines.append(f"• 多空收益: {row['多空收益']:.3f}")
    report_lines.append(f"• p值: {row['p值']:.3f}")
    report_lines.append("")
    
    # 评测分析
    report_lines.append("评测分析:")
    report_lines.extend(generate_evaluation_analysis(row))
    report_lines.append("")
    
    # 详细指标分析
    report_lines.append("详细指标分析:")
    report_lines.extend(generate_detailed_indicator_analysis(row, rank, len(positive_factors)))
    report_lines.append("")
    
    # 使用建议
    report_lines.append("具体使用建议:")
    report_lines.extend(generate_usage_suggestions(row, "正向"))
    report_lines.append("")
    
    # 风险提示
    report_lines.append("风险提示:")
    report_lines.extend(generate_risk_warnings(row, "正向"))
    report_lines.append("")
    report_lines.append("=" * 50)
    report_lines.append("")
    
    return report_lines
```

#### 2.4 负向因子分析函数
```python
def generate_negative_factors_analysis(negative_factors, analysis_params):
    """
    生成负向因子详细分析
    
    Args:
        negative_factors: 负向因子DataFrame
        analysis_params: 分析参数
        
    Returns:
        list: 报告行列表
    """
    report_lines = []
    
    # 标题
    report_lines.append("3. 负向因子详细分析")
    report_lines.append("=" * 60)
    report_lines.append("")
    
    # 3.1 负向因子排行榜（按IC绝对值排序）
    report_lines.append("3.1 负向因子排行榜")
    report_lines.append("-" * 40)
    report_lines.append("")
    report_lines.append(f"【共 {len(negative_factors)} 个负向因子】")
    report_lines.append("")
    
    # 按IC绝对值排序
    negative_factors_abs = negative_factors.copy()
    negative_factors_abs['IC绝对值'] = abs(negative_factors_abs['IC均值'])
    negative_factors_abs = negative_factors_abs.sort_values('IC绝对值', ascending=False)
    
    # 表格头
    report_lines.append(f"{'排名':<4} {'因子名称':<25} {'得分':<8} {'评级':<8} {'IC均值':<10} {'|IC|':<10}")
    report_lines.append("-" * 80)
    
    for i, row in negative_factors_abs.iterrows():
        rank = i + 1
        factor_name = row['因子名称']
        score = f"{row['综合得分']:.1f}"
        rating = row['评级']
        ic_mean = f"{row['IC均值']:.3f}"
        ic_abs = f"{abs(row['IC均值']):.3f}"
        
        report_lines.append(f"{rank:<4} {factor_name:<25} {score:<8} {rating:<8} {ic_mean:<10} {ic_abs:<10}")
    
    report_lines.append("")
    if len(negative_factors_abs) > 0:
        best_negative = negative_factors_abs.iloc[0]
        report_lines.append(f"最佳负向因子: {best_negative['因子名称']} (排名第1，IC={best_negative['IC均值']:.3f})")
    report_lines.append("")
    
    # 3.2 负向因子综合评估
    report_lines.append("3.2 负向因子综合评估")
    report_lines.append("-" * 40)
    report_lines.append("")
    
    if len(negative_factors) > 0:
        # 统计信息
        total_count = len(negative_factors)
        avg_ic = negative_factors['IC均值'].mean()
        avg_ic_abs = abs(avg_ic)
        avg_ir = negative_factors['IR值'].mean()
        strongest_ic = negative_factors['IC均值'].min()  # 最负的IC
        strongest_ir = negative_factors['IR值'].min()
        
        # 评级分布
        rating_dist = negative_factors['评级'].value_counts()
        
        report_lines.append(f"负向因子总数: {total_count}个")
        report_lines.append(f"平均IC均值: {avg_ic:.3f}")
        report_lines.append(f"平均IC绝对值: {avg_ic_abs:.3f}")
        report_lines.append(f"平均IR值: {avg_ir:.3f}")
        report_lines.append(f"最强负向IC: {strongest_ic:.3f}")
        report_lines.append(f"最强负向IR: {strongest_ir:.3f}")
        report_lines.append("")
        report_lines.append("评级分布:")
        for rating, count in rating_dist.items():
            report_lines.append(f"  {rating}级: {count}个")
        report_lines.append("")
    
    # 3.3 各负向因子详细分析
    report_lines.append("3.3 各负向因子详细分析")
    report_lines.append("-" * 40)
    report_lines.append("")
    
    # 按IC绝对值排序后分析
    for i, row in negative_factors_abs.iterrows():
        report_lines.extend(generate_negative_factor_detail_analysis(row, i + 1))
    
    # 3.4 负向因子使用建议
    report_lines.append("3.4 负向因子使用建议")
    report_lines.append("-" * 40)
    report_lines.append("")
    report_lines.extend(generate_negative_factors_usage_suggestions(negative_factors))
    
    return report_lines

def generate_negative_factor_detail_analysis(row, rank):
    """
    生成单个负向因子的详细分析
    """
    report_lines = []
    
    report_lines.append(f"【{row['评级']}】{row['因子名称']}")
    report_lines.append("-" * 50)
    report_lines.append(f"综合得分: {row['综合得分']:.1f}/10")
    report_lines.append(f"风险等级: {get_risk_level(row['综合得分'])}")
    report_lines.append("")
    
    report_lines.append("核心指标:")
    report_lines.append(f"• IC均值: {row['IC均值']:.3f}")
    report_lines.append(f"• IR值: {row['IR值']:.3f}")
    report_lines.append(f"• 多空收益: {row['多空收益']:.3f}")
    report_lines.append(f"• p值: {row['p值']:.3f}")
    report_lines.append("")
    
    # 负向因子深度分析
    report_lines.append("负向因子深度分析:")
    report_lines.extend(generate_negative_factor_analysis(row))
    report_lines.append("")
    
    # 详细指标分析
    report_lines.append("详细指标分析:")
    report_lines.extend(generate_detailed_indicator_analysis(row, rank, len(negative_factors)))
    report_lines.append("")
    
    # 使用建议
    report_lines.append("具体使用建议:")
    report_lines.extend(generate_usage_suggestions(row, "负向"))
    report_lines.append("")
    
    # 风险提示
    report_lines.append("风险提示:")
    report_lines.extend(generate_risk_warnings(row, "负向"))
    report_lines.append("")
    report_lines.append("=" * 50)
    report_lines.append("")
    
    return report_lines

def generate_negative_factor_analysis(row):
    """
    生成负向因子的专门分析
    """
    analysis_lines = []
    
    # 因子类型判断
    ic_value = abs(row['IC均值'])
    if ic_value >= 0.05:
        strength = "强负向"
    elif ic_value >= 0.03:
        strength = "中等负向"
    elif ic_value >= 0.01:
        strength = "弱负向"
    else:
        strength = "极弱负向"
    
    analysis_lines.append(f"• 该因子为负向因子（IC均值={row['IC均值']:.3f}），与收益呈反向关系")
    analysis_lines.append(f"• 负向强度评估: {strength} - 因子值与收益关系明确")
    analysis_lines.append(f"• 反向使用潜力: {'高' if ic_value >= 0.03 else '中等' if ic_value >= 0.01 else '低'}")
    
    # 反向策略建议
    if ic_value >= 0.05:
        strategy = "强烈推荐反向策略"
        weight_range = "-15% 至 -25%"
    elif ic_value >= 0.03:
        strategy = "推荐反向策略"
        weight_range = "-10% 至 -15%"
    elif ic_value >= 0.01:
        strategy = "谨慎反向策略"
        weight_range = "-3% 至 -8%"
    else:
        strategy = "不建议反向使用"
        weight_range = "0%"
    
    analysis_lines.append(f"• 反向策略建议: {strategy}")
    analysis_lines.append(f"• 建议权重: {weight_range}")
    analysis_lines.append(f"• 使用策略: 因子值高时做空，因子值低时做多")
    
    return analysis_lines
```

#### 2.5 因子组合建议函数
```python
def generate_factor_combination_suggestions(positive_factors, negative_factors):
    """
    生成因子组合配置建议
    """
    suggestion_lines = []
    
    suggestion_lines.append("4. 因子组合配置建议")
    suggestion_lines.append("=" * 60)
    suggestion_lines.append("")
    
    # 4.1 核心因子组合
    suggestion_lines.append("4.1 核心因子组合推荐")
    suggestion_lines.append("-" * 40)
    suggestion_lines.append("")
    
    if len(positive_factors) > 0:
        # 推荐的核心正向因子
        top_positive = positive_factors.iloc[0]
        suggestion_lines.append(f"核心正向因子: {top_positive['因子名称']}")
        suggestion_lines.append(f"• 建议权重: 10-20%")
        suggestion_lines.append(f"• 使用策略: 因子值高时增加仓位")
        suggestion_lines.append(f"• 预期贡献: 高正向收益贡献")
        suggestion_lines.append("")
    
    if len(negative_factors) > 0:
        # 推荐的核心负向因子
        negative_factors_abs = negative_factors.copy()
        negative_factors_abs['IC绝对值'] = abs(negative_factors_abs['IC均值'])
        top_negative = negative_factors_abs.sort_values('IC绝对值', ascending=False).iloc[0]
        
        suggestion_lines.append(f"核心负向因子: {top_negative['因子名称']}")
        suggestion_lines.append(f"• 建议权重: -10% 至 -15%")
        suggestion_lines.append(f"• 使用策略: 反向使用，因子值高时做空")
        suggestion_lines.append(f"• 预期贡献: 对冲正向因子风险")
        suggestion_lines.append("")
    
    # 4.2 辅助因子配置
    suggestion_lines.append("4.2 辅助因子配置")
    suggestion_lines.append("-" * 40)
    suggestion_lines.append("")
    
    if len(positive_factors) > 1:
        suggestion_lines.append("辅助正向因子:")
        for i, row in positive_factors.iloc[1:3].iterrows():
            if row['IC均值'] >= 0.05:
                weight = "5-10%"
            elif row['IC均值'] >= 0.02:
                weight = "2-5%"
            else:
                weight = "1-3%"
            suggestion_lines.append(f"• {row['因子名称']}: 权重{weight}")
    
    if len(negative_factors) > 1:
        suggestion_lines.append("辅助负向因子:")
        negative_factors_abs = negative_factors.copy()
        negative_factors_abs['IC绝对值'] = abs(negative_factors_abs['IC均值'])
        for i, row in negative_factors_abs.iloc[1:3].iterrows():
            ic_abs = abs(row['IC均值'])
            if ic_abs >= 0.03:
                weight = "-5% 至 -8%"
            elif ic_abs >= 0.01:
                weight = "-2% 至 -5%"
            else:
                weight = "-1% 至 -3%"
            suggestion_lines.append(f"• {row['因子名称']}: 权重{weight}")
    
    suggestion_lines.append("")
    
    # 4.3 风险管理建议
    suggestion_lines.append("4.3 风险管理建议")
    suggestion_lines.append("-" * 40)
    suggestion_lines.append("")
    suggestion_lines.append("• 权重控制:")
    suggestion_lines.append("  - 单因子权重不超过20%")
    suggestion_lines.append("  - 正向因子总权重不超过50%")
    suggestion_lines.append("  - 负向因子总权重不超过30%")
    suggestion_lines.append("")
    suggestion_lines.append("• 动态调整:")
    suggestion_lines.append("  - 定期重新评估因子有效性")
    suggestion_lines.append("  - 根据市场环境调整权重")
    suggestion_lines.append("  - 设置止损机制")
    suggestion_lines.append("")
    suggestion_lines.append("• 组合优化:")
    suggestion_lines.append("  - 考虑因子间的相关性")
    suggestion_lines.append("  - 避免过度集中于单一类型因子")
    suggestion_lines.append("  - 定期进行组合再平衡")
    
    return suggestion_lines
```

#### 2.6 辅助函数
```python
def generate_factor_classification_overview(positive_factors, negative_factors):
    """
    生成因子分类概览
    """
    overview_lines = []
    
    overview_lines.append("1. 因子分类概览")
    overview_lines.append("=" * 60)
    overview_lines.append("")
    
    # 1.1 正向因子概览
    overview_lines.append("1.1 正向因子概览")
    overview_lines.append("-" * 40)
    overview_lines.append("")
    overview_lines.append(f"正向因子数量: {len(positive_factors)}个")
    
    if len(positive_factors) > 0:
        avg_ic = positive_factors['IC均值'].mean()
        max_ic = positive_factors['IC均值'].max()
        avg_score = positive_factors['综合得分'].mean()
        
        overview_lines.append(f"平均IC均值: {avg_ic:.3f}")
        overview_lines.append(f"最高IC均值: {max_ic:.3f}")
        overview_lines.append(f"平均综合得分: {avg_score:.1f}")
        
        # 最佳因子
        best_factor = positive_factors.iloc[0]
        overview_lines.append(f"最佳因子: {best_factor['因子名称']} (IC={best_factor['IC均值']:.3f})")
    
    overview_lines.append("")
    
    # 1.2 负向因子概览
    overview_lines.append("1.2 负向因子概览")
    overview_lines.append("-" * 40)
    overview_lines.append("")
    overview_lines.append(f"负向因子数量: {len(negative_factors)}个")
    
    if len(negative_factors) > 0:
        avg_ic = negative_factors['IC均值'].mean()
        min_ic = negative_factors['IC均值'].min()  # 最负的IC
        avg_score = negative_factors['综合得分'].mean()
        avg_ic_abs = abs(avg_ic)
        
        overview_lines.append(f"平均IC均值: {avg_ic:.3f}")
        overview_lines.append(f"最强负向IC: {min_ic:.3f}")
        overview_lines.append(f"平均IC绝对值: {avg_ic_abs:.3f}")
        overview_lines.append(f"平均综合得分: {avg_score:.1f}")
        
        # 最佳负向因子
        negative_factors_abs = negative_factors.copy()
        negative_factors_abs['IC绝对值'] = abs(negative_factors_abs['IC均值'])
        best_negative = negative_factors_abs.sort_values('IC绝对值', ascending=False).iloc[0]
        overview_lines.append(f"最佳负向因子: {best_negative['因子名称']} (IC={best_negative['IC均值']:.3f})")
    
    overview_lines.append("")
    
    return overview_lines

def generate_evaluation_analysis(row):
    """
    生成评测分析
    """
    analysis_lines = []
    
    score = row['综合得分']
    ic_mean = row['IC均值']
    ir_value = row['IR值']
    
    if score >= 3.0:
        level = "优秀"
        recommendation = "强烈推荐使用"
    elif score >= 2.0:
        level = "良好"
        recommendation = "推荐使用"
    elif score >= 1.5:
        level = "一般"
        recommendation = "谨慎使用"
    elif score >= 1.0:
        level = "较弱"
        recommendation = "不建议使用"
    else:
        level = "差"
        recommendation = "避免使用"
    
    analysis_lines.append(f"✓ 评级: {level}（{row['评级']}级）")
    analysis_lines.append(f"✓ 建议: {recommendation}")
    analysis_lines.append(f"✓ 类型: {'正向因子' if ic_mean > 0 else '负向因子'}")
    
    if abs(ir_value) >= 0.3:
        stability = "稳定性良好"
    elif abs(ir_value) >= 0.1:
        stability = "稳定性一般"
    else:
        stability = "稳定性较差"
    
    analysis_lines.append(f"✓ 稳定性: {stability}")
    
    return analysis_lines

def generate_detailed_indicator_analysis(row, rank, total_count):
    """
    生成详细指标分析
    """
    indicator_lines = []
    
    # 预测能力评估
    ic_value = row['IC均值']
    if ic_value > 0:
        ic_desc = f"{ic_value:.3f} (IC均值)"
        if ic_value >= 0.12:
            prediction = "优秀，IC均值超过12%"
        elif ic_value >= 0.08:
            prediction = "良好，IC均值超过8%"
        elif ic_value >= 0.05:
            prediction = "一般，IC均值超过5%"
        elif ic_value >= 0.02:
            prediction = "较弱，IC均值为正"
        else:
            prediction = "很差，IC均值过小"
    else:
        ic_desc = f"{ic_value:.3f} (IC均值)"
        if abs(ic_value) >= 0.05:
            prediction = "强负向，IC均值绝对值超过5%"
        elif abs(ic_value) >= 0.03:
            prediction = "中等负向，IC均值绝对值超过3%"
        elif abs(ic_value) >= 0.01:
            prediction = "弱负向，IC均值绝对值超过1%"
        else:
            prediction = "极弱负向，IC均值绝对值过小"
    
    indicator_lines.append(f"• 预测能力评估: {ic_desc}")
    indicator_lines.append(f"  - 预测能力: {prediction}")
    indicator_lines.append(f"  - 排名: 第{rank}名 (共{total_count}个因子)")
    
    # 稳定性评估
    ir_value = row['IR值']
    ir_desc = f"{ir_value:.3f} (IR值)"
    if abs(ir_value) >= 1.0:
        stability = "优秀，IR值绝对值超过1.0"
    elif abs(ir_value) >= 0.5:
        stability = "良好，IR值绝对值超过0.5"
    elif abs(ir_value) >= 0.3:
        stability = "一般，IR值绝对值超过0.3"
    elif abs(ir_value) >= 0.15:
        stability = "较弱，IR值绝对值超过0.15"
    else:
        stability = "很差，IR值绝对值过小"
    
    indicator_lines.append(f"• 稳定性评估: {ir_desc}")
    indicator_lines.append(f"  - 稳定性: {stability}")
    indicator_lines.append(f"  - 排名: 第{rank}名 (共{total_count}个因子)")
    
    # 收益表现
    return_value = row['多空收益']
    return_desc = f"{return_value:.3f} (多空收益)"
    if return_value > 0.05:
        performance = "优秀，年化多空收益超过5%"
    elif return_value > 0.03:
        performance = "良好，年化多空收益超过3%"
    elif return_value > 0.02:
        performance = "中等，年化多空收益超过2%"
    elif return_value > 0.01:
        performance = "较弱，年化多空收益超过1%"
    elif return_value > 0:
        performance = "一般，年化多空收益为正")
    else:
        performance = "较差，年化多空收益为负"
    
    indicator_lines.append(f"• 收益表现: {return_desc}")
    indicator_lines.append(f"  - 收益表现: {performance}")
    indicator_lines.append(f"  - 排名: 第{rank}名 (共{total_count}个因子)")
    
    # 统计显著性
    p_value = row['p值']
    p_desc = f"{p_value:.3f} (p值)"
    if p_value < 0.01:
        significance = "高度显著 (p < 0.01)"
    elif p_value < 0.05:
        significance = "显著 (p < 0.05)"
    elif p_value < 0.1:
        significance = "边缘显著 (p < 0.1)"
    else:
        significance = "不显著 (p >= 0.1)"
    
    indicator_lines.append(f"• 统计显著性: {p_desc}")
    indicator_lines.append(f"  - 统计显著性: {significance}")
    indicator_lines.append(f"  - 排名: 第{rank}名 (共{total_count}个因子)")
    
    return indicator_lines

def generate_usage_suggestions(row, factor_type):
    """
    生成使用建议
    """
    suggestions_lines = []
    
    score = row['综合得分']
    
    if factor_type == "正向":
        if score >= 3.0:
            weight = "15-25%"
            strategy = "作为核心因子使用"
        elif score >= 2.0:
            weight = "8-15%"
            strategy = "作为主要因子使用"
        elif score >= 1.5:
            weight = "5-10%"
            strategy = "作为辅助因子使用"
        elif score >= 1.0:
            weight = "2-5%"
            strategy = "谨慎使用"
        else:
            weight = "0-2%"
            strategy = "不推荐使用"
    else:  # 负向因子
        ic_abs = abs(row['IC均值'])
        if ic_abs >= 0.08:
            weight = "-15% 至 -25%"
            strategy = "强烈推荐反向使用"
        elif ic_abs >= 0.05:
            weight = "-10% 至 -15%"
            strategy = "推荐反向使用"
        elif ic_abs >= 0.03:
            weight = "-5% 至 -10%"
            strategy = "谨慎反向使用"
        elif ic_abs >= 0.01:
            weight = "-2% 至 -5%"
            strategy = "小仓位反向使用"
        else:
            weight = "0%"
            strategy = "不推荐使用"
    
    suggestions_lines.append(f"• 权重建议: {weight}")
    suggestions_lines.append(f"• 使用策略: {strategy}")
    suggestions_lines.append(f"• 监控频率: 每月重新评估一次")
    
    return suggestions_lines

def generate_risk_warnings(row, factor_type):
    """
    生成风险提示
    """
    warnings_lines = []
    
    score = row['综合得分']
    
    if score >= 3.0:
        risk_level = "低风险"
        description = "因子表现优秀，建议正常使用"
    elif score >= 2.0:
        risk_level = "中低风险"
        description = "因子表现良好，建议正常使用"
    elif score >= 1.5:
        risk_level = "中等风险"
        description = "因子表现一般，需要加强监控"
    else:
        risk_level = "高风险"
        description = "因子表现较差，不建议使用"
    
    warnings_lines.append(f"• {risk_level}: {description}")
    
    p_value = row['p值']
    if p_value >= 0.1:
        warnings_lines.append(f"• 统计风险: 统计不显著，结果可能存在偶然性")
    
    warnings_lines.append(f"• 市场风险: 需要关注市场环境变化对因子有效性的影响")
    
    return warnings_lines

def get_risk_level(score):
    """
    根据得分获取风险等级
    """
    if score >= 3.0:
        return "低"
    elif score >= 2.0:
        return "中低"
    elif score >= 1.5:
        return "中等"
    else:
        return "高"

def generate_positive_factors_usage_suggestions(positive_factors):
    """
    生成正向因子使用建议
    """
    suggestions_lines = []
    
    if len(positive_factors) == 0:
        suggestions_lines.append("暂无正向因子，建议寻找新的正向因子指标。")
        return suggestions_lines
    
    suggestions_lines.append("基于当前正向因子的使用建议:")
    suggestions_lines.append("")
    
    # A级因子建议
    a_grade = positive_factors[positive_factors['评级'].str.contains('A', na=False)]
    if len(a_grade) > 0:
        suggestions_lines.append("A级正向因子:")
        for _, row in a_grade.iterrows():
            suggestions_lines.append(f"• {row['因子名称']}: 权重15-25%，核心配置")
        suggestions_lines.append("")
    
    # B级因子建议
    b_grade = positive_factors[positive_factors['评级'].str.contains('B', na=False)]
    if len(b_grade) > 0:
        suggestions_lines.append("B级正向因子:")
        for _, row in b_grade.iterrows():
            suggestions_lines.append(f"• {row['因子名称']}: 权重5-15%，辅助配置")
        suggestions_lines.append("")
    
    # C级及以下因子建议
    c_grade = positive_factors[positive_factors['评级'].str.contains('C|D', na=False)]
    if len(c_grade) > 0:
        suggestions_lines.append("C级及以下正向因子:")
        for _, row in c_grade.iterrows():
            suggestions_lines.append(f"• {row['因子名称']}: 权重0-5%，谨慎使用")
        suggestions_lines.append("")
    
    return suggestions_lines

def generate_negative_factors_usage_suggestions(negative_factors):
    """
    生成负向因子使用建议
    """
    suggestions_lines = []
    
    if len(negative_factors) == 0:
        suggestions_lines.append("暂无负向因子，无需考虑反向策略。")
        return suggestions_lines
    
    suggestions_lines.append("基于当前负向因子的使用建议:")
    suggestions_lines.append("")
    
    # 按IC绝对值排序
    negative_factors_abs = negative_factors.copy()
    negative_factors_abs['IC绝对值'] = abs(negative_factors_abs['IC均值'])
    negative_factors_sorted = negative_factors_abs.sort_values('IC绝对值', ascending=False)
    
    suggestions_lines.append("反向策略建议（按负向强度排序）:")
    suggestions_lines.append("")
    
    for _, row in negative_factors_sorted.iterrows():
        ic_abs = abs(row['IC均值'])
        
        if ic_abs >= 0.08:
            weight = "-20% 至 -25%"
            priority = "强烈推荐"
        elif ic_abs >= 0.05:
            weight = "-15% 至 -20%"
            priority = "推荐"
        elif ic_abs >= 0.03:
            weight = "-10% 至 -15%"
            priority = "一般推荐"
        elif ic_abs >= 0.01:
            weight = "-3% 至 -8%"
            priority = "谨慎使用"
        else:
            weight = "0%"
            priority = "不推荐"
        
        suggestions_lines.append(f"• {row['因子名称']}: {priority}反向使用")
        suggestions_lines.append(f"  - 建议权重: {weight}")
        suggestions_lines.append(f"  - 使用方式: 因子值高时做空，因子值低时做多")
        suggestions_lines.append("")
    
    suggestions_lines.append("负向因子风险管理:")
    suggestions_lines.append("• 控制负向因子总权重不超过30%")
    suggestions_lines.append("• 建议与正向因子组合使用，实现风险对冲")
    suggestions_lines.append("• 定期监控负向因子的有效性变化")
    
    return suggestions_lines
```

### 3. 主要改进点

#### 3.1 结构改进
- **清晰的分类**: 明确分离正向因子和负向因子
- **单独分析**: 对每类因子进行专门的分析和建议
- **逻辑清晰**: 按照正向→负向→组合的逻辑顺序

#### 3.2 内容改进
- **负向因子专门分析**: 增加负向因子深度分析部分
- **反向策略建议**: 为负向因子提供具体的反向使用建议
- **组合配置**: 提供正负因子组合配置的具体建议

#### 3.3 实用性改进
- **权重建议**: 为每类因子提供具体的权重配置建议
- **风险管理**: 增加详细的风险管理建议
- **动态调整**: 提供基于市场环境的调整建议

### 4. 实施步骤

1. **备份现有代码**: 保存原始的yihnzifenxi1119.py文件
2. **实施代码修改**: 按照上述方案逐步修改代码
3. **测试验证**: 运行修改后的代码，生成新的分类报告
4. **对比验证**: 确保新的报告格式和内容符合要求
5. **部署使用**: 替换原有代码，开始使用新的分析报告

### 5. 预期效果

- **更好的可读性**: 用户可以更清楚地理解每类因子的特点
- **更明确的使用指导**: 为正向因子和负向因子提供不同的使用策略
- **更强的实用性**: 提供具体的权重配置和风险管理建议
- **更科学的组合配置**: 基于因子分类提供科学的组合配置建议

这个修改方案将显著提升因子分析报告的实用性和指导价值。
