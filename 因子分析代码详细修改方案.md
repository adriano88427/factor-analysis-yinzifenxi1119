# å› å­åˆ†æä»£ç è¯¦ç»†ä¿®æ”¹æ–¹æ¡ˆ

## æ¦‚è¿°

åŸºäºå¯¹ `yinzifenxi1119.py` æ–‡ä»¶çš„æ·±å…¥åˆ†æï¼Œå‘ç°äº†å¤šä¸ªéœ€è¦ä¿®å¤çš„ä»£ç é—®é¢˜ã€‚æœ¬æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„ä¿®æ”¹æ–¹æ¡ˆï¼Œ**ä¸åŒ…å«å®é™…ä»£ç ä¿®æ”¹**ï¼Œä»…ä¸ºå¼€å‘äººå‘˜æä¾›ä¿®å¤æŒ‡å¯¼ã€‚

## é—®é¢˜æ¸…å•ä¸ä¿®å¤æ–¹æ¡ˆ

### 1. é‡å¤å‡½æ•°å®šä¹‰é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°ï¼š** å­˜åœ¨ä¸¤ä¸ª `calculate_ic` å‡½æ•°å®šä¹‰ï¼Œä¸€ä¸ªçŸ­ç‰ˆæœ¬ï¼ˆçº¦45è¡Œï¼‰ï¼Œä¸€ä¸ªå®Œæ•´ç‰ˆæœ¬ï¼ˆçº¦350è¡Œï¼‰ã€‚

**å‘ç°ä½ç½®ï¼š**
- çŸ­ç‰ˆæœ¬ï¼š`FactorAnalysis` ç±»ä¸­ï¼Œç¬¬**è¡Œå·¦å³
- å®Œæ•´ç‰ˆæœ¬ï¼š`FactorAnalysis` ç±»ä¸­ï¼Œç¨åä½ç½®

**ä¿®å¤æ–¹æ¡ˆï¼š** âœ… **å·²æ‰§è¡Œ**
- åˆ é™¤äº†çŸ­ç‰ˆæœ¬çš„ `calculate_ic` å‡½æ•°
- ä¿ç•™äº†å®Œæ•´ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬åŒ…å«æ›´å…¨é¢çš„åŠŸèƒ½
- ç¡®ä¿å‡½æ•°å‚æ•°ä¸€è‡´æ€§ï¼š`calculate_ic(self, factor_col, use_pearson=False, use_robust_corr=False, use_kendall=False, use_nonparam_test=False, compute_bootstrap_ci=False, n_bootstrap=1000)`

### 2. ç©ºreturnè¯­å¥é—®é¢˜ ğŸ”´ éœ€è¦ä¿®å¤

**é—®é¢˜æè¿°ï¼š** å­˜åœ¨3ä¸ªç©ºçš„ `return` è¯­å¥ä½äº `logger.close()` ä¹‹åï¼Œè¿™äº›ä»£ç æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

**å‘ç°ä½ç½®ï¼š**
1. ç¬¬**è¡Œé™„è¿‘ï¼š`logger.close()` ä¹‹åçš„ `return`
2. ç¬¬**è¡Œé™„è¿‘ï¼š`logger.close()` ä¹‹åçš„ `return`  
3. ç¬¬**è¡Œé™„è¿‘ï¼š`logger.close()` ä¹‹åçš„ `return`

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```python
logger.close()  # å…³é—­æ—¥å¿—è®°å½•å™¨
return
print("æ•°æ®é¢„å¤„ç†å¤±è´¥ï¼Œç¨‹åºé€€å‡º")  # è¿™è¡Œæ°¸è¿œä¸ä¼šæ‰§è¡Œ
```

**ä¿®å¤æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ1ï¼šåˆ é™¤æ‰€æœ‰ç©ºçš„returnè¯­å¥**
```python
# åˆ é™¤æ‰€æœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç å—ï¼š
logger.close()  # å…³é—­æ—¥å¿—è®°å½•å™¨
return  # åˆ é™¤è¿™è¡Œ
print("æ•°æ®é¢„å¤„ç†å¤±è´¥ï¼Œç¨‹åºé€€å‡º")  # åˆ é™¤æˆ–ä¿ç•™è¿™è¡Œ
```

**æ–¹æ¡ˆ2ï¼šæ·»åŠ æ­£ç¡®çš„å¼‚å¸¸å¤„ç†é€»è¾‘**
```python
try:
    # åŸæœ‰é€»è¾‘
except Exception as e:
    print(f"æ•°æ®é¢„å¤„ç†å¤±è´¥ï¼Œç¨‹åºé€€å‡º")
    logger.close()
    sys.exit(1)  # æ·»åŠ ç¨‹åºé€€å‡º
```

### 3. å˜é‡ç±»å‹æ£€æŸ¥é—®é¢˜ ğŸ”´ éœ€è¦ä¿®å¤

**é—®é¢˜æè¿°ï¼š** å¤šä¸ªå‡½æ•°ç¼ºå°‘å¯¹è¾“å…¥å‚æ•°çš„ç±»å‹æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

**ä¸»è¦é—®é¢˜ä½ç½®ï¼š**

**3.1 ensure_list å‡½æ•°ä½¿ç”¨ä¸å½“**
- **é—®é¢˜ï¼š** åœ¨ `calculate_ic` å‡½æ•°ä¸­ï¼Œ`daily_ics = ensure_list(daily_ics, "daily_ics")` è¢«å¤šæ¬¡è°ƒç”¨
- **é£é™©ï¼š** å¦‚æœ `daily_ics` åˆå§‹ä¸º `None`ï¼Œ`ensure_list` è¿”å›ç©ºåˆ—è¡¨ `[]`ï¼Œä½†åç»­ä»£ç æœŸæœ›å®ƒæ˜¯åˆ—è¡¨ç±»å‹
- **ä¿®å¤æ–¹æ¡ˆï¼š**
```python
# åœ¨å‡½æ•°å¼€å§‹æ—¶åˆå§‹åŒ–
daily_ics = []
# åˆ é™¤æ‰€æœ‰ ensure_list è°ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨åˆ—è¡¨æ“ä½œ
```

**3.2 numpy.isnan ç±»å‹æ£€æŸ¥é—®é¢˜**
- **é—®é¢˜ï¼š** `if np.isnan(annual_return) or np.isnan(observation_years) or np.isnan(original_total_return):`
- **é£é™©ï¼š** å¦‚æœè¾“å…¥ä¸æ˜¯æ•°å€¼ç±»å‹ï¼Œä¼šæŠ›å‡º TypeError
- **ä¿®å¤æ–¹æ¡ˆï¼š**
```python
try:
    annual_return = float(annual_return)
    observation_years = float(observation_years)  
    original_total_return = float(original_total_return)
    if np.isnan(annual_return) or np.isnan(observation_years) or np.isnan(original_total_return):
        return {'valid': False, 'error': 'è¾“å…¥å‚æ•°åŒ…å«NaNå€¼'}
except (TypeError, ValueError):
    return {'valid': False, 'error': 'è¾“å…¥å‚æ•°æ— æ³•è½¬æ¢ä¸ºæ•°å€¼ç±»å‹'}
```

### 4. æ•°ç»„å½¢çŠ¶å…¼å®¹æ€§é—®é¢˜ ğŸ”´ éœ€è¦ä¿®å¤

**é—®é¢˜æè¿°ï¼š** æ•°ç»„æ“ä½œä¸­å¯èƒ½å­˜åœ¨å½¢çŠ¶ä¸å…¼å®¹çš„é—®é¢˜ã€‚

**é—®é¢˜ä½ç½®ï¼š** `calculate_group_returns` å‡½æ•°ä¸­çš„å¹´åŒ–è®¡ç®—éƒ¨åˆ†

**ä¿®å¤æ–¹æ¡ˆï¼š**
```python
# ä¿®å¤å‰ï¼š
annual_std = daily_std_returns * np.sqrt(observation_years * 252 / holding_period)
annual_sharpe = np.where(annual_std > 0, standard_annual_returns / annual_std, 0.0)

# ä¿®å¤åï¼š
# ç¡®ä¿æ•°ç»„æ˜¯ä¸€ç»´çš„
daily_std_returns = np.asarray(daily_std_returns).flatten()
standard_annual_returns = np.asarray(standard_annual_returns).flatten()
annual_std = daily_std_returns * np.sqrt(observation_years * 252 / holding_period)
annual_sharpe = np.where(annual_std > 0, standard_annual_returns / annual_std, 0.0)
```

### 5. å¼‚å¸¸å¤„ç†æ”¹è¿› ğŸ”´ éœ€è¦ä¿®å¤

**é—®é¢˜æè¿°ï¼š** å¤šä¸ªå‡½æ•°ç¼ºå°‘é€‚å½“çš„å¼‚å¸¸å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒã€‚

**ä¸»è¦é—®é¢˜ä½ç½®ï¼š**

**5.1 è‡ªå®šä¹‰å‡½æ•°ç¼ºå°‘å¼‚å¸¸å¤„ç†**
- `custom_spearman_corr` å‡½æ•°
- `kendall_tau_corr` å‡½æ•°
- `robust_correlation` å‡½æ•°

**ä¿®å¤æ–¹æ¡ˆï¼š**
```python
def custom_spearman_corr(x, y):
    """è®¡ç®—Spearmanç›¸å…³ç³»æ•°ï¼Œç¡®ä¿æ•°å­¦ä¸Šçš„å‡†ç¡®æ€§"""
    try:
        # è½¬æ¢ä¸ºnumpyæ•°ç»„
        x = np.asarray(x, dtype=float)
        y = np.asarray(y, dtype=float)
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®ç‚¹å’Œæ•°æ®é•¿åº¦æ˜¯å¦åŒ¹é…
        if len(x) < 2 or len(y) < 2 or len(x) != len(y):
            return np.nan
        
        # æ£€æŸ¥æ˜¯å¦æœ‰NaNå€¼æˆ–æ— ç©·å€¼
        if np.isnan(x).any() or np.isnan(y).any() or np.isinf(x).any() or np.isinf(y).any():
            return np.nan
        
        # åŸæœ‰è®¡ç®—é€»è¾‘...
        
        return corr
    except Exception as e:
        print(f"Spearmanç›¸å…³ç³»æ•°è®¡ç®—é”™è¯¯: {str(e)}")
        return np.nan
```

**5.2 æ–‡ä»¶æ“ä½œç¼ºå°‘å¼‚å¸¸å¤„ç†**
- **é—®é¢˜ä½ç½®ï¼š** `load_data` å‡½æ•°
- **ä¿®å¤æ–¹æ¡ˆï¼š** æ·»åŠ æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥å’Œç¼–ç å¤„ç†

```python
def load_data(self):
    """ä»æ–‡ä»¶åŠ è½½æ•°æ®"""
    try:
        if not os.path.exists(self.file_path):
            raise FileNotFoundError(f"æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨: {self.file_path}")
            
        if self.file_path.endswith('.csv'):
            # å°è¯•ä¸åŒç¼–ç 
            for encoding in ['utf-8-sig', 'gbk', 'utf-8']:
                try:
                    self.data = pd.read_csv(self.file_path, encoding=encoding)
                    break
                except UnicodeDecodeError:
                    continue
            else:
                raise ValueError("æ— æ³•ç”¨ä»»ä½•ç¼–ç è¯»å–CSVæ–‡ä»¶")
        elif self.file_path.endswith('.xlsx') or self.file_path.endswith('.xls'):
            self.data = pd.read_excel(self.file_path)
        else:
            raise ValueError("ä»…æ”¯æŒCSVå’ŒExcelæ–‡ä»¶æ ¼å¼")
        
        return True
    except Exception as e:
        print(f"æ•°æ®åŠ è½½å¤±è´¥: {e}")
        return False
```

### 6. æ€§èƒ½ä¼˜åŒ–å»ºè®® ğŸ”´ å»ºè®®ä¿®å¤

**é—®é¢˜æè¿°ï¼š** éƒ¨åˆ†ä»£ç å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´å¤„ç†å¤§é‡æ•°æ®æ—¶æ•ˆç‡ä½ä¸‹ã€‚

**6.1 é‡å¤è®¡ç®—é—®é¢˜**
- **é—®é¢˜ï¼š** `calculate_group_returns` å‡½æ•°ä¸­å¤šæ¬¡è°ƒç”¨ç›¸åŒçš„è®¡ç®—
- **ä¿®å¤æ–¹æ¡ˆï¼š** ç¼“å­˜è®¡ç®—ç»“æœ

**6.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
- **é—®é¢˜ï¼š** å¤§æ•°æ®é›†æ—¶å¯èƒ½å ç”¨è¿‡å¤šå†…å­˜
- **ä¿®å¤æ–¹æ¡ˆï¼š** ä½¿ç”¨ç”Ÿæˆå™¨å’Œåˆ†å—å¤„ç†

### 7. ä»£ç ç»“æ„ä¼˜åŒ– ğŸŸ¡ å¯é€‰ä¿®å¤

**7.1 å‡½æ•°æ‹†åˆ†**
- `calculate_ic` å‡½æ•°è¿‡é•¿ï¼ˆ350+è¡Œï¼‰ï¼Œå»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°
- `calculate_group_returns` å‡½æ•°åŠŸèƒ½å¤æ‚ï¼Œå»ºè®®æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†

**7.2 å¸¸é‡å®šä¹‰**
- æ·»åŠ é…ç½®å¸¸é‡ï¼Œå¦‚åˆ†ç»„æ•°é‡é»˜è®¤å€¼ã€ç½®ä¿¡åŒºé—´å‚æ•°ç­‰

```python
# å»ºè®®æ·»åŠ çš„é…ç½®å¸¸é‡
DEFAULT_GROUP_COUNT = 5
BOOTSTRAP_ITERATIONS = 1000
CONFIDENCE_LEVEL = 0.95
MIN_SAMPLE_SIZE = 10
```

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. **ç©ºreturnè¯­å¥é—®é¢˜** - å½±å“ç¨‹åºé€»è¾‘æ­£ç¡®æ€§
2. **å˜é‡ç±»å‹æ£€æŸ¥é—®é¢˜** - å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
3. **æ•°ç»„å½¢çŠ¶å…¼å®¹æ€§é—®é¢˜** - å¯èƒ½å¯¼è‡´è®¡ç®—é”™è¯¯

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
4. **å¼‚å¸¸å¤„ç†æ”¹è¿›** - æé«˜ç¨‹åºå¥å£®æ€§
5. **æ€§èƒ½ä¼˜åŒ–** - æé«˜å¤„ç†æ•ˆç‡

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¿®å¤ï¼‰
6. **ä»£ç ç»“æ„ä¼˜åŒ–** - æé«˜ä»£ç å¯ç»´æŠ¤æ€§
7. **æ·»åŠ å•å…ƒæµ‹è¯•** - ç¡®ä¿ä»£ç è´¨é‡

## ä¿®å¤éªŒè¯æ–¹æ¡ˆ

### 1. è¯­æ³•æ£€æŸ¥
```bash
python -m py_compile yinzifenxi1119.py
```

### 2. å•å…ƒæµ‹è¯•
åˆ›å»ºæµ‹è¯•ç”¨ä¾‹éªŒè¯æ¯ä¸ªä¿®å¤çš„åŠŸèƒ½ï¼š
- æµ‹è¯• `calculate_ic` å‡½æ•°çš„å¼‚å¸¸æƒ…å†µ
- æµ‹è¯• `load_data` å‡½æ•°çš„æ–‡ä»¶å¤„ç†
- æµ‹è¯•æ•°æ®é¢„å¤„ç†åŠŸèƒ½

### 3. é›†æˆæµ‹è¯•
ä½¿ç”¨å®é™…æ•°æ®è¿è¡Œå®Œæ•´æµç¨‹ï¼ŒéªŒè¯æ‰€æœ‰ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆã€‚

## æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½åŸæ–‡ä»¶**ï¼šåœ¨è¿›è¡Œä»»ä½•ä¿®æ”¹å‰ï¼Œç¡®ä¿å¤‡ä»½åŸå§‹æ–‡ä»¶
2. **é€æ­¥ä¿®å¤**ï¼šå»ºè®®é€ä¸ªä¿®å¤é—®é¢˜ï¼Œæ¯æ¬¡ä¿®å¤åè¿›è¡Œæµ‹è¯•
3. **å‘åå…¼å®¹**ï¼šç¡®ä¿ä¿®å¤ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
4. **æ–‡æ¡£æ›´æ–°**ï¼šä¿®å¤åéœ€è¦æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæ³¨é‡Š

## æ€»ç»“

æœ¬ä¿®æ”¹æ–¹æ¡ˆè¯†åˆ«äº†ä»£ç ä¸­çš„ä¸»è¦é—®é¢˜ï¼Œæä¾›äº†è¯¦ç»†çš„ä¿®å¤æŒ‡å¯¼ã€‚æ ¸å¿ƒé—®é¢˜é›†ä¸­åœ¨å¼‚å¸¸å¤„ç†ã€ç±»å‹æ£€æŸ¥å’Œç¨‹åºé€»è¾‘æ–¹é¢ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œä¿®å¤ï¼Œä¼˜å…ˆè§£å†³é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œä»¥ç¡®ä¿ç¨‹åºç¨³å®šæ€§å’Œæ­£ç¡®æ€§ã€‚

---
*æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š2025-11-21*  
*åˆ†æå¯¹è±¡ï¼šyinzifenxi1119.py*  
*ä¿®å¤çŠ¶æ€ï¼šæ–¹æ¡ˆå·²åˆ¶å®šï¼Œç­‰å¾…å®æ–½*
